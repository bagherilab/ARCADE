<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatchSeries.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">arcade</a> &gt; <a href="index.source.html" class="el_package">arcade.patch.sim</a> &gt; <span class="el_source">PatchSeries.java</span></div><h1>PatchSeries.java</h1><pre class="source lang-java linenums">package arcade.patch.sim;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import arcade.core.sim.Series;
import arcade.core.util.Box;
import arcade.core.util.MiniBox;
import static arcade.core.util.MiniBox.TAG_SEPARATOR;

/** Simulation manager for {@link PatchSimulation} instances. */
public final class PatchSeries extends Series {
    /** Map of patch settings. */
    public MiniBox patch;

    /** Radius of the simulation. */
    public final int radius;

    /** Depth of the simulation. */
    public final int depth;

    /** Overall radius of the simulation (equal to RADIUS + MARGIN). */
    public final int radiusBounds;

    /** Overall height of the simulation (equal to 1 if DEPTH = 1, or DEPTH + MARGIN otherwise). */
    public final int depthBounds;

    /**
     * Creates a {@code Series} object given setup information parsed from XML.
     *
     * @param setupDicts the map of attribute to value for single instance tags
     * @param setupLists the map of attribute to value for multiple instance tags
     * @param path the path for simulation output
     * @param parameters the default parameter values
     * @param isVis {@code true} if visualized, {@code false} otherwise
     */
    public PatchSeries(
            HashMap&lt;String, MiniBox&gt; setupDicts,
            HashMap&lt;String, ArrayList&lt;Box&gt;&gt; setupLists,
            String path,
            Box parameters,
            boolean isVis) {
<span class="fc" id="L43">        super(setupDicts, setupLists, path, parameters, isVis);</span>

        // Set sizing.
<span class="fc" id="L46">        MiniBox series = setupDicts.get(&quot;series&quot;);</span>
<span class="fc" id="L47">        this.radius = series.getInt(&quot;radius&quot;);</span>
<span class="fc" id="L48">        this.depth = series.getInt(&quot;depth&quot;);</span>
<span class="fc" id="L49">        this.radiusBounds = series.getInt(&quot;radiusBounds&quot;);</span>
<span class="fc" id="L50">        this.depthBounds = series.getInt(&quot;depthBounds&quot;);</span>
<span class="fc" id="L51">    }</span>

    @Override
    protected String getSimClass() {
<span class="fc bfc" id="L55" title="All 2 branches covered.">        String geometry = patch.get(&quot;GEOMETRY&quot;).equalsIgnoreCase(&quot;HEX&quot;) ? &quot;Hex&quot; : &quot;Rect&quot;;</span>
<span class="fc" id="L56">        return &quot;arcade.patch.sim.PatchSimulation&quot; + geometry;</span>
    }

    @Override
    protected String getVisClass() {
<span class="fc" id="L61">        return &quot;arcade.patch.vis.PatchVisualization&quot;;</span>
    }

    /**
     * Initializes series simulation, agents, and environment.
     *
     * @param setupLists the map of attribute to value for multiple instance tags
     * @param parameters the default parameter values loaded from {@code parameter.xml}
     */
    @Override
    protected void initialize(HashMap&lt;String, ArrayList&lt;Box&gt;&gt; setupLists, Box parameters) {
        // Initialize populations.
<span class="fc" id="L73">        MiniBox populationDefaults = parameters.getIdValForTag(&quot;POPULATION&quot;);</span>
<span class="fc" id="L74">        MiniBox populationConversions = parameters.getIdValForTagAtt(&quot;POPULATION&quot;, &quot;conversion&quot;);</span>
<span class="fc" id="L75">        ArrayList&lt;Box&gt; populationsBox = setupLists.get(&quot;populations&quot;);</span>
<span class="fc" id="L76">        updatePopulations(populationsBox, populationDefaults, populationConversions);</span>

        // Initialize layers.
<span class="fc" id="L79">        MiniBox layerDefaults = parameters.getIdValForTag(&quot;LAYER&quot;);</span>
<span class="fc" id="L80">        MiniBox layerConversions = parameters.getIdValForTagAtt(&quot;LAYER&quot;, &quot;conversion&quot;);</span>
<span class="fc" id="L81">        ArrayList&lt;Box&gt; layersBox = setupLists.get(&quot;layers&quot;);</span>
<span class="fc" id="L82">        updateLayers(layersBox, layerDefaults, layerConversions);</span>

        // Add actions.
<span class="fc" id="L85">        MiniBox actionDefaults = parameters.getIdValForTag(&quot;ACTION&quot;);</span>
<span class="fc" id="L86">        ArrayList&lt;Box&gt; actionsBox = setupLists.get(&quot;actions&quot;);</span>
<span class="fc" id="L87">        updateActions(actionsBox, actionDefaults);</span>

        // Add components.
<span class="fc" id="L90">        MiniBox componentDefaults = parameters.getIdValForTag(&quot;COMPONENT&quot;);</span>
<span class="fc" id="L91">        ArrayList&lt;Box&gt; componentsBox = setupLists.get(&quot;components&quot;);</span>
<span class="fc" id="L92">        updateComponents(componentsBox, componentDefaults);</span>

        // Initialize patch.
<span class="fc" id="L95">        MiniBox patchDefaults = parameters.getIdValForTag(&quot;PATCH&quot;);</span>
<span class="fc" id="L96">        ArrayList&lt;Box&gt; patchBox = setupLists.get(&quot;patch&quot;);</span>
<span class="fc" id="L97">        updatePatch(patchBox, patchDefaults);</span>
<span class="fc" id="L98">    }</span>

    /**
     * Configures patch model parameters.
     *
     * @param patchBox the patch setup dictionary
     * @param patchDefaults the dictionary of default patch parameters
     */
    void updatePatch(ArrayList&lt;Box&gt; patchBox, MiniBox patchDefaults) {
<span class="fc" id="L107">        this.patch = new MiniBox();</span>

<span class="fc" id="L109">        Box box = new Box();</span>
<span class="fc bfc" id="L110" title="All 6 branches covered.">        if (patchBox != null &amp;&amp; patchBox.size() == 1 &amp;&amp; patchBox.get(0) != null) {</span>
<span class="fc" id="L111">            box = patchBox.get(0);</span>
        }

        // Get default parameters and any parameter tags.
<span class="fc" id="L115">        Box parameters = box.filterBoxByTag(&quot;PARAMETER&quot;);</span>
<span class="fc" id="L116">        MiniBox parameterValues = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;value&quot;);</span>
<span class="fc" id="L117">        MiniBox parameterScales = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;scale&quot;);</span>

        // Add in parameters.
<span class="fc bfc" id="L120" title="All 2 branches covered.">        for (String parameter : patchDefaults.getKeys()) {</span>
<span class="fc" id="L121">            parseParameter(</span>
                    this.patch,
                    parameter,
<span class="fc" id="L124">                    patchDefaults.get(parameter),</span>
                    parameterValues,
                    parameterScales);
<span class="fc" id="L127">        }</span>

        // Add in constants.
<span class="fc" id="L130">        MiniBox constants = box.getIdVal();</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        for (String constantKey : constants.getKeys()) {</span>
<span class="fc" id="L132">            this.patch.put(constantKey, constants.get(constantKey));</span>
<span class="fc" id="L133">        }</span>
<span class="fc" id="L134">    }</span>

    @Override
    protected void updatePopulations(
            ArrayList&lt;Box&gt; populationsBox,
            MiniBox populationDefaults,
            MiniBox populationConversions) {
<span class="fc" id="L141">        this.populations = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">        if (populationsBox == null) {</span>
<span class="fc" id="L143">            return;</span>
        }

        // Assign codes to each population.
<span class="fc" id="L147">        int code = 1;</span>

        // Iterate through each setup dictionary to build population settings.
<span class="fc bfc" id="L150" title="All 2 branches covered.">        for (Box box : populationsBox) {</span>
<span class="fc" id="L151">            String id = box.getValue(&quot;id&quot;);</span>
<span class="fc" id="L152">            String populationClass = box.getValue(&quot;class&quot;);</span>

            // Create new population and update code.
<span class="fc" id="L155">            MiniBox population = new MiniBox();</span>
<span class="fc" id="L156">            population.put(&quot;CODE&quot;, code++);</span>
<span class="fc" id="L157">            population.put(&quot;CLASS&quot;, populationClass);</span>
<span class="fc" id="L158">            this.populations.put(id, population);</span>

            // Add population init if given. If value ends with percentage (%),
            // use the PERCENT initialization type instead of the COUNT
            // initialization type. If not given or invalid, set to zero.
<span class="fc" id="L163">            String initType = &quot;COUNT&quot;;</span>
<span class="fc bfc" id="L164" title="All 4 branches covered.">            if (box.getValue(&quot;init&quot;) != null &amp;&amp; box.getValue(&quot;init&quot;).endsWith(&quot;%&quot;)) {</span>
<span class="fc" id="L165">                box.add(&quot;init&quot;, box.getValue(&quot;init&quot;).replace(&quot;%&quot;, &quot;&quot;));</span>
<span class="fc" id="L166">                initType = &quot;PERCENT&quot;;</span>
            }
            int init =
<span class="fc bfc" id="L169" title="All 2 branches covered.">                    (isValidNumber(box, &quot;init&quot;)</span>
<span class="fc" id="L170">                            ? (int) Double.parseDouble(box.getValue(&quot;init&quot;))</span>
<span class="fc" id="L171">                            : 0);</span>
<span class="fc" id="L172">            population.put(initType, init);</span>

            // Get default parameters and any parameter adjustments.
<span class="fc" id="L175">            Box parameters = box.filterBoxByTag(&quot;PARAMETER&quot;);</span>
<span class="fc" id="L176">            MiniBox parameterValues = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;value&quot;);</span>
<span class="fc" id="L177">            MiniBox parameterScales = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;scale&quot;);</span>

            // Apply conversion factors.
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">            for (String convert : populationConversions.getKeys()) {</span>
<span class="nc" id="L181">                double conversion = parseConversion(populationConversions.get(convert), ds, dt);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                if (parameterScales.contains(convert)) {</span>
<span class="nc" id="L183">                    parameterScales.put(convert, parameterScales.getDouble(convert) * conversion);</span>
                } else {
<span class="nc" id="L185">                    parameterScales.put(convert, conversion);</span>
                }
<span class="nc" id="L187">            }</span>

            // Add in parameters. Start with value (if given) or default (if not
            // given). Then apply any scaling.
<span class="fc bfc" id="L191" title="All 2 branches covered.">            for (String parameter : populationDefaults.getKeys()) {</span>
<span class="fc" id="L192">                parseParameter(</span>
                        population,
                        parameter,
<span class="fc" id="L195">                        populationDefaults.get(parameter),</span>
                        parameterValues,
                        parameterScales);
<span class="fc" id="L198">            }</span>

            // Get list of links, if valid.
<span class="fc" id="L201">            MiniBox links = box.filterBoxByTag(&quot;LINK&quot;).getIdValForTagAtt(&quot;LINK&quot;, &quot;weight&quot;);</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">            for (String link : links.getKeys()) {</span>
<span class="fc" id="L203">                population.put(&quot;(LINK)&quot; + TAG_SEPARATOR + link, links.getDouble(link));</span>
<span class="fc" id="L204">            }</span>

            // Extract process versions.
<span class="fc" id="L207">            Box processes = box.filterBoxByTag(&quot;PROCESS&quot;);</span>
<span class="fc" id="L208">            MiniBox processVersions = processes.getIdValForTagAtt(&quot;PROCESS&quot;, &quot;version&quot;);</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">            for (String process : processes.getKeys()) {</span>
<span class="fc" id="L210">                String version = processVersions.get(process);</span>
<span class="fc" id="L211">                population.put(&quot;(PROCESS)&quot; + TAG_SEPARATOR + process, version);</span>
<span class="fc" id="L212">            }</span>
<span class="fc" id="L213">        }</span>
<span class="fc" id="L214">    }</span>

    @Override
    protected void updateLayers(
            ArrayList&lt;Box&gt; layersBox, MiniBox layerDefaults, MiniBox layerConversions) {
<span class="fc" id="L219">        this.layers = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (layersBox == null) {</span>
<span class="fc" id="L221">            return;</span>
        }

        // Iterate through each setup dictionary to build layer settings.
<span class="nc bnc" id="L225" title="All 2 branches missed.">        for (Box box : layersBox) {</span>
<span class="nc" id="L226">            String id = box.getValue(&quot;id&quot;);</span>

            // Create new layer.
<span class="nc" id="L229">            MiniBox layer = new MiniBox();</span>
<span class="nc" id="L230">            this.layers.put(id, layer);</span>

            // Get default parameters and any parameter adjustments.
<span class="nc" id="L233">            Box parameters = box.filterBoxByTag(&quot;PARAMETER&quot;);</span>
<span class="nc" id="L234">            MiniBox parameterValues = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;value&quot;);</span>
<span class="nc" id="L235">            MiniBox parameterScales = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;scale&quot;);</span>

            // Add in parameters. Start with value (if given) or default (if not
            // given). Then apply any scaling.
<span class="nc bnc" id="L239" title="All 2 branches missed.">            for (String parameter : layerDefaults.getKeys()) {</span>
<span class="nc" id="L240">                parseParameter(</span>
                        layer,
                        parameter,
<span class="nc" id="L243">                        layerDefaults.get(parameter),</span>
                        parameterValues,
                        parameterScales);
<span class="nc" id="L246">            }</span>

            // Apply conversion factors.
<span class="nc bnc" id="L249" title="All 2 branches missed.">            for (String convert : layerConversions.getKeys()) {</span>
<span class="nc" id="L250">                double conversion = parseConversion(layerConversions.get(convert), ds, dz, dt);</span>
<span class="nc" id="L251">                layer.put(convert, layer.getDouble(convert) * conversion);</span>
<span class="nc" id="L252">            }</span>

            // Get list of operations.
<span class="nc" id="L255">            HashSet&lt;String&gt; operations = box.filterTags(&quot;OPERATION&quot;);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            for (String operation : operations) {</span>
<span class="nc" id="L257">                layer.put(&quot;(OPERATION)&quot; + TAG_SEPARATOR + operation, &quot;&quot;);</span>
<span class="nc" id="L258">            }</span>
<span class="nc" id="L259">        }</span>
<span class="nc" id="L260">    }</span>

    @Override
    protected void updateActions(ArrayList&lt;Box&gt; actionsBox, MiniBox actionDefaults) {
<span class="fc" id="L264">        this.actions = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">        if (actionsBox == null) {</span>
<span class="fc" id="L266">            return;</span>
        }

        // Iterate through each setup dictionary to build action settings.
<span class="nc bnc" id="L270" title="All 2 branches missed.">        for (Box box : actionsBox) {</span>
<span class="nc" id="L271">            String id = box.getValue(&quot;id&quot;);</span>
<span class="nc" id="L272">            String actionClass = box.getValue(&quot;class&quot;).toLowerCase();</span>

            // Create new population and update code.
<span class="nc" id="L275">            MiniBox action = new MiniBox();</span>
<span class="nc" id="L276">            this.actions.put(id, action);</span>

            // Filter defaults for parameters specific to action class.
<span class="nc" id="L279">            action.put(&quot;CLASS&quot;, actionClass);</span>
<span class="nc" id="L280">            MiniBox actionClassDefaults = actionDefaults.filter(actionClass);</span>

            // Get default parameters and any parameter adjustments.
<span class="nc" id="L283">            Box parameters = box.filterBoxByTag(&quot;PARAMETER&quot;);</span>
<span class="nc" id="L284">            MiniBox parameterValues = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;value&quot;);</span>
<span class="nc" id="L285">            MiniBox parameterScales = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;scale&quot;);</span>

            // Add in parameters. Start with value (if given) or default (if not
            // given). Then apply any scaling.
<span class="nc bnc" id="L289" title="All 2 branches missed.">            for (String parameter : actionClassDefaults.getKeys()) {</span>
<span class="nc" id="L290">                parseParameter(</span>
                        action,
                        parameter,
<span class="nc" id="L293">                        actionClassDefaults.get(parameter),</span>
                        parameterValues,
                        parameterScales);
<span class="nc" id="L296">            }</span>

            // Add list of registered populations.
<span class="nc" id="L299">            HashSet&lt;String&gt; registers = box.filterTags(&quot;REGISTER&quot;);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">            for (String register : registers) {</span>
<span class="nc" id="L301">                action.put(&quot;(REGISTER)&quot; + TAG_SEPARATOR + register, &quot;&quot;);</span>
<span class="nc" id="L302">            }</span>
<span class="nc" id="L303">        }</span>
<span class="nc" id="L304">    }</span>

    @Override
    protected void updateComponents(ArrayList&lt;Box&gt; componentsBox, MiniBox componentDefaults) {
<span class="fc" id="L308">        this.components = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">        if (componentsBox == null) {</span>
<span class="fc" id="L310">            return;</span>
        }

        // Iterate through each setup dictionary to build component settings.
<span class="nc bnc" id="L314" title="All 2 branches missed.">        for (Box box : componentsBox) {</span>
<span class="nc" id="L315">            String id = box.getValue(&quot;id&quot;);</span>
<span class="nc" id="L316">            String componentClass = box.getValue(&quot;class&quot;).toLowerCase();</span>

            // Create new population and update code.
<span class="nc" id="L319">            MiniBox component = new MiniBox();</span>
<span class="nc" id="L320">            this.components.put(id, component);</span>

            // Filter defaults for parameters specific to component class.
<span class="nc" id="L323">            component.put(&quot;CLASS&quot;, componentClass);</span>
<span class="nc" id="L324">            MiniBox componentClassDefaults = componentDefaults.filter(componentClass);</span>

            // Get default parameters and any parameter adjustments.
<span class="nc" id="L327">            Box parameters = box.filterBoxByTag(&quot;PARAMETER&quot;);</span>
<span class="nc" id="L328">            MiniBox parameterValues = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;value&quot;);</span>
<span class="nc" id="L329">            MiniBox parameterScales = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;scale&quot;);</span>

            // Add in parameters. Start with value (if given) or default (if not
            // given). Then apply any scaling.
<span class="nc bnc" id="L333" title="All 2 branches missed.">            for (String parameter : componentClassDefaults.getKeys()) {</span>
<span class="nc" id="L334">                parseParameter(</span>
                        component,
                        parameter,
<span class="nc" id="L337">                        componentClassDefaults.get(parameter),</span>
                        parameterValues,
                        parameterScales);
<span class="nc" id="L340">            }</span>

            // Add list of registered layers.
<span class="nc" id="L343">            HashSet&lt;String&gt; registers = box.filterTags(&quot;REGISTER&quot;);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            for (String register : registers) {</span>
<span class="nc" id="L345">                component.put(&quot;(REGISTER)&quot; + TAG_SEPARATOR + register, &quot;&quot;);</span>
<span class="nc" id="L346">            }</span>
<span class="nc" id="L347">        }</span>
<span class="nc" id="L348">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>