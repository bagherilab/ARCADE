<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PottsSeries.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">arcade</a> &gt; <a href="index.source.html" class="el_package">arcade.potts.sim</a> &gt; <span class="el_source">PottsSeries.java</span></div><h1>PottsSeries.java</h1><pre class="source lang-java linenums">package arcade.potts.sim;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import arcade.core.sim.Series;
import arcade.core.util.Box;
import arcade.core.util.MiniBox;
import static arcade.core.util.MiniBox.TAG_SEPARATOR;
import static arcade.potts.util.PottsEnums.Term;

/** Simulation manager for {@link PottsSimulation} instances. */
public final class PottsSeries extends Series {
    /** Separator character for targets. */
    public static final String TARGET_SEPARATOR = &quot;:&quot;;

    /** Default cell class. */
    public static final String DEFAULT_CELL_CLASS = &quot;stem&quot;;

    /** Map of potts settings. */
    public MiniBox potts;

    /** List of Hamiltonian terms. */
    public ArrayList&lt;Term&gt; terms;

    /**
     * Creates a {@code Series} object given setup information parsed from XML.
     *
     * @param setupDicts the map of attribute to value for single instance tags
     * @param setupLists the map of attribute to value for multiple instance tags
     * @param path the path for simulation output
     * @param parameters the default parameter values
     * @param isVis {@code true} if visualized, {@code false} otherwise
     */
    public PottsSeries(
            HashMap&lt;String, MiniBox&gt; setupDicts,
            HashMap&lt;String, ArrayList&lt;Box&gt;&gt; setupLists,
            String path,
            Box parameters,
            boolean isVis) {
<span class="fc" id="L41">        super(setupDicts, setupLists, path, parameters, isVis);</span>
<span class="fc" id="L42">    }</span>

    @Override
    protected String getSimClass() {
<span class="fc bfc" id="L46" title="All 2 branches covered.">        return &quot;arcade.potts.sim.PottsSimulation&quot; + (height &gt; 1 ? &quot;3D&quot; : &quot;2D&quot;);</span>
    }

    @Override
    protected String getVisClass() {
<span class="fc" id="L51">        return &quot;arcade.potts.vis.PottsVisualization&quot;;</span>
    }

    /**
     * Initializes series simulation, agents, and environment.
     *
     * @param setupLists the map of attribute to value for multiple instance tags
     * @param parameters the default parameter values loaded from {@code parameter.xml}
     */
    @Override
    protected void initialize(HashMap&lt;String, ArrayList&lt;Box&gt;&gt; setupLists, Box parameters) {
        // Initialize populations.
<span class="fc" id="L63">        MiniBox populationDefaults = parameters.getIdValForTag(&quot;POPULATION&quot;);</span>
<span class="fc" id="L64">        MiniBox populationConversions = parameters.getIdValForTagAtt(&quot;POPULATION&quot;, &quot;conversion&quot;);</span>
<span class="fc" id="L65">        ArrayList&lt;Box&gt; populationsBox = setupLists.get(&quot;populations&quot;);</span>
<span class="fc" id="L66">        updatePopulations(populationsBox, populationDefaults, populationConversions);</span>

        // Initialize layers.
<span class="fc" id="L69">        MiniBox layerDefaults = parameters.getIdValForTag(&quot;LAYER&quot;);</span>
<span class="fc" id="L70">        MiniBox layerConversions = parameters.getIdValForTagAtt(&quot;LAYER&quot;, &quot;conversion&quot;);</span>
<span class="fc" id="L71">        ArrayList&lt;Box&gt; layersBox = setupLists.get(&quot;layers&quot;);</span>
<span class="fc" id="L72">        updateLayers(layersBox, layerDefaults, layerConversions);</span>

        // Add actions.
<span class="fc" id="L75">        MiniBox actionDefaults = parameters.getIdValForTag(&quot;ACTION&quot;);</span>
<span class="fc" id="L76">        ArrayList&lt;Box&gt; actionsBox = setupLists.get(&quot;actions&quot;);</span>
<span class="fc" id="L77">        updateActions(actionsBox, actionDefaults);</span>

        // Add components.
<span class="fc" id="L80">        MiniBox componentDefaults = parameters.getIdValForTag(&quot;COMPONENT&quot;);</span>
<span class="fc" id="L81">        ArrayList&lt;Box&gt; componentsBox = setupLists.get(&quot;components&quot;);</span>
<span class="fc" id="L82">        updateComponents(componentsBox, componentDefaults);</span>

        // Initialize potts.
<span class="fc" id="L85">        MiniBox pottsDefaults = parameters.getIdValForTag(&quot;POTTS&quot;);</span>
<span class="fc" id="L86">        MiniBox pottsConversions = parameters.getIdValForTagAtt(&quot;POTTS&quot;, &quot;conversion&quot;);</span>
<span class="fc" id="L87">        ArrayList&lt;Box&gt; pottsBox = setupLists.get(&quot;potts&quot;);</span>
<span class="fc" id="L88">        updatePotts(pottsBox, pottsDefaults, pottsConversions);</span>
<span class="fc" id="L89">    }</span>

    /**
     * Calculates potts model parameters.
     *
     * @param pottsBox the potts setup dictionary
     * @param pottsDefaults the dictionary of default potts parameters
     * @param pottsConversions the dictionary of potts parameter conversions
     */
    void updatePotts(ArrayList&lt;Box&gt; pottsBox, MiniBox pottsDefaults, MiniBox pottsConversions) {
<span class="fc" id="L99">        this.potts = new MiniBox();</span>

<span class="fc" id="L101">        Box box = new Box();</span>
<span class="fc bfc" id="L102" title="All 6 branches covered.">        if (pottsBox != null &amp;&amp; pottsBox.size() == 1 &amp;&amp; pottsBox.get(0) != null) {</span>
<span class="fc" id="L103">            box = pottsBox.get(0);</span>
        }

        // Get default parameters and any parameter tags.
<span class="fc" id="L107">        Box parameters = box.filterBoxByTag(&quot;PARAMETER&quot;);</span>
<span class="fc" id="L108">        MiniBox parameterValues = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;value&quot;);</span>
<span class="fc" id="L109">        MiniBox parameterScales = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;scale&quot;);</span>

        // Add in parameters. Start with value (if given) or default (if not
        // given). Then apply any scaling.
<span class="fc bfc" id="L113" title="All 2 branches covered.">        for (String parameter : pottsDefaults.getKeys()) {</span>
<span class="fc" id="L114">            parseParameter(</span>
                    this.potts,
                    parameter,
<span class="fc" id="L117">                    pottsDefaults.get(parameter),</span>
                    parameterValues,
                    parameterScales);

<span class="fc bfc" id="L121" title="All 2 branches covered.">            if (parameter.contains(TAG_SEPARATOR)) {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                for (String pop : populations.keySet()) {</span>
<span class="fc" id="L123">                    parseParameter(</span>
                            this.potts,
                            parameter + TARGET_SEPARATOR + pop,
<span class="fc" id="L126">                            this.potts.get(parameter),</span>
                            parameterValues,
                            parameterScales);
<span class="fc" id="L129">                }</span>
            }
<span class="fc" id="L131">        }</span>

        // Add adhesion values for each population and media (*). Values
        // are set as equal to the default (or adjusted) value, before
        // any specific values or scaling is applied.
<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (String source : populations.keySet()) {</span>
<span class="fc" id="L137">            String adhesion = &quot;adhesion/ADHESION&quot; + TARGET_SEPARATOR + source;</span>
<span class="fc" id="L138">            parseParameter(</span>
                    this.potts,
                    adhesion + TARGET_SEPARATOR + &quot;*&quot;,
<span class="fc" id="L141">                    this.potts.get(adhesion),</span>
                    parameterValues,
                    parameterScales);

<span class="fc bfc" id="L145" title="All 2 branches covered.">            for (String target : populations.keySet()) {</span>
<span class="fc" id="L146">                parseParameter(</span>
                        this.potts,
                        adhesion + TARGET_SEPARATOR + target,
<span class="fc" id="L149">                        this.potts.get(adhesion),</span>
                        parameterValues,
                        parameterScales);
<span class="fc" id="L152">            }</span>
<span class="fc" id="L153">        }</span>

        // Add adhesion values for each population that has regions.
<span class="fc bfc" id="L156" title="All 2 branches covered.">        for (String pop : populations.keySet()) {</span>
<span class="fc" id="L157">            ArrayList&lt;String&gt; regions = populations.get(pop).filter(&quot;(REGION)&quot;).getKeys();</span>

<span class="fc bfc" id="L159" title="All 2 branches covered.">            for (String source : regions) {</span>
<span class="fc" id="L160">                String adhesion = &quot;adhesion/ADHESION_&quot; + source + TARGET_SEPARATOR + pop;</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">                for (String target : regions) {</span>
<span class="fc" id="L163">                    parseParameter(</span>
                            this.potts,
                            adhesion + TARGET_SEPARATOR + target,
<span class="fc" id="L166">                            this.potts.get(adhesion),</span>
                            parameterValues,
                            parameterScales);
<span class="fc" id="L169">                }</span>
<span class="fc" id="L170">            }</span>
<span class="fc" id="L171">        }</span>

        // Apply conversion factors.
<span class="fc bfc" id="L174" title="All 2 branches covered.">        for (String convert : pottsConversions.getKeys()) {</span>
<span class="fc" id="L175">            double conversion = parseConversion(pottsConversions.get(convert), ds, dt);</span>
<span class="fc" id="L176">            this.potts.put(convert, this.potts.getDouble(convert) * conversion);</span>

<span class="fc bfc" id="L178" title="All 2 branches covered.">            if (convert.contains(TAG_SEPARATOR)) {</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">                for (String pop : populations.keySet()) {</span>
<span class="fc" id="L180">                    String convertPop = convert + TARGET_SEPARATOR + pop;</span>
<span class="fc" id="L181">                    this.potts.put(convertPop, this.potts.getDouble(convertPop) * conversion);</span>
<span class="fc" id="L182">                }</span>
            }
<span class="fc" id="L184">        }</span>

        // Get list of terms.
<span class="fc" id="L187">        this.terms = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">        for (String term : box.filterTags(&quot;TERM&quot;)) {</span>
<span class="fc" id="L189">            terms.add(Term.valueOf(term.toUpperCase()));</span>
<span class="fc" id="L190">        }</span>
<span class="fc" id="L191">    }</span>

    @Override
    protected void updatePopulations(
            ArrayList&lt;Box&gt; populationsBox,
            MiniBox populationDefaults,
            MiniBox populationConversions) {
<span class="fc" id="L198">        this.populations = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (populationsBox == null) {</span>
<span class="fc" id="L200">            return;</span>
        }

        // Assign codes to each population.
<span class="fc" id="L204">        int code = 1;</span>

        // Iterate through each setup dictionary to build population settings.
<span class="fc bfc" id="L207" title="All 2 branches covered.">        for (Box box : populationsBox) {</span>
<span class="fc" id="L208">            String id = box.getValue(&quot;id&quot;);</span>
<span class="fc" id="L209">            String populationClass = box.getValue(&quot;class&quot;);</span>

<span class="fc bfc" id="L211" title="All 2 branches covered.">            if (populationClass == null) {</span>
<span class="fc" id="L212">                populationClass = DEFAULT_CELL_CLASS;</span>
            }

            // TODO: Use logger to print message when default class is used.

            // Create new population and update code.
<span class="fc" id="L218">            MiniBox population = new MiniBox();</span>
<span class="fc" id="L219">            population.put(&quot;CODE&quot;, code++);</span>
<span class="fc" id="L220">            population.put(&quot;CLASS&quot;, populationClass);</span>
<span class="fc" id="L221">            this.populations.put(id, population);</span>

            // Add population init if given. If not given or invalid, set to zero.
<span class="fc bfc" id="L224" title="All 4 branches covered.">            if (box.contains(&quot;init&quot;) &amp;&amp; box.getValue(&quot;init&quot;).contains(&quot;:&quot;)) {</span>
<span class="fc" id="L225">                String[] initString = box.getValue(&quot;init&quot;).split(&quot;:&quot;);</span>

<span class="fc" id="L227">                box.add(&quot;init&quot;, initString[0]);</span>
<span class="fc" id="L228">                box.add(&quot;padding&quot;, initString[1]);</span>

                int padding =
<span class="fc bfc" id="L231" title="All 2 branches covered.">                        (isValidNumber(box, &quot;padding&quot;)</span>
<span class="fc" id="L232">                                ? (int) Double.parseDouble(box.getValue(&quot;padding&quot;))</span>
<span class="fc" id="L233">                                : 0);</span>
<span class="fc" id="L234">                population.put(&quot;PADDING&quot;, padding);</span>
            }

            int init =
<span class="fc bfc" id="L238" title="All 2 branches covered.">                    (isValidNumber(box, &quot;init&quot;)</span>
<span class="fc" id="L239">                            ? (int) Double.parseDouble(box.getValue(&quot;init&quot;))</span>
<span class="fc" id="L240">                            : 0);</span>
<span class="fc" id="L241">            population.put(&quot;INIT&quot;, init);</span>

            // Get default parameters and any parameter adjustments.
<span class="fc" id="L244">            Box parameters = box.filterBoxByTag(&quot;PARAMETER&quot;);</span>
<span class="fc" id="L245">            MiniBox parameterValues = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;value&quot;);</span>
<span class="fc" id="L246">            MiniBox parameterScales = parameters.getIdValForTagAtt(&quot;PARAMETER&quot;, &quot;scale&quot;);</span>

            // Add in parameters. Start with value (if given) or default (if not
            // given). Then apply any scaling.
<span class="fc bfc" id="L250" title="All 2 branches covered.">            for (String parameter : populationDefaults.getKeys()) {</span>
<span class="fc" id="L251">                parseParameter(</span>
                        population,
                        parameter,
<span class="fc" id="L254">                        populationDefaults.get(parameter),</span>
                        parameterValues,
                        parameterScales);
<span class="fc" id="L257">            }</span>

            // Get list of links, if valid.
<span class="fc" id="L260">            MiniBox links = box.filterBoxByTag(&quot;LINK&quot;).getIdValForTagAtt(&quot;LINK&quot;, &quot;weight&quot;);</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">            for (String link : links.getKeys()) {</span>
<span class="fc" id="L262">                population.put(&quot;(LINK)&quot; + TAG_SEPARATOR + link, links.getDouble(link));</span>
<span class="fc" id="L263">            }</span>

            // Get list of regions, if valid.
<span class="fc" id="L266">            HashSet&lt;String&gt; regions = box.filterTags(&quot;REGION&quot;);</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">            for (String region : regions) {</span>
<span class="fc" id="L268">                population.put(&quot;(REGION)&quot; + TAG_SEPARATOR + region, &quot;&quot;);</span>
<span class="fc" id="L269">            }</span>

            // Apply conversion factors.
<span class="fc bfc" id="L272" title="All 2 branches covered.">            for (String convert : populationConversions.getKeys()) {</span>
<span class="fc" id="L273">                double conversion = parseConversion(populationConversions.get(convert), ds, dt);</span>
<span class="fc" id="L274">                population.put(convert, population.getDouble(convert) * conversion);</span>
<span class="fc" id="L275">            }</span>
<span class="fc" id="L276">        }</span>
<span class="fc" id="L277">    }</span>

    @Override
    protected void updateLayers(
            ArrayList&lt;Box&gt; layersBox, MiniBox layerDefaults, MiniBox layerConversions) {
        // TODO
<span class="fc" id="L283">    }</span>

    @Override
    protected void updateActions(ArrayList&lt;Box&gt; actionsBox, MiniBox actionDefaults) {
        // TODO
<span class="fc" id="L288">    }</span>

    @Override
    protected void updateComponents(ArrayList&lt;Box&gt; componentsBox, MiniBox componentDefaults) {
        // TODO
<span class="fc" id="L293">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>